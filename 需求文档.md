# Todo 应用后端 API

基于 Java Spring Boot 3.0 的 RESTful 待办事项管理 API，支持完整的 CRUD、状态切换、批量删除、分页、过滤、健康检查、Swagger 文档等。

## 1. 技术栈

- Java 21
- Spring Boot 3.0
- Spring Data JPA
- MySQL 8.4.6
- Lombok
- Swagger (springdoc-openapi)

## 2. 数据库配置

- 地址：localhost:3306
- 用户名：mysql
- 密码：空
- 数据库名：todoapp

## 3. 数据库设计

### 3.1 数据表结构

#### todos 表
```sql
CREATE TABLE todos (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    completed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 3.2 索引设计
```sql
-- 创建索引优化查询性能
CREATE INDEX idx_todos_completed ON todos(completed);
CREATE INDEX idx_todos_created_at ON todos(created_at);
CREATE INDEX idx_todos_title ON todos(title);
```

### 3.3 初始化数据
```sql
-- 插入示例数据
INSERT INTO todos (title, description, completed) VALUES 
('学习Spring Boot', '完成Spring Boot基础教程', FALSE),
('完成项目文档', '编写技术架构文档', FALSE),
('代码审查', '审查待办事项应用代码', TRUE);
```

## 4. API接口规范

### 4.1 基础信息
- **Base URL**: `http://localhost:8000/api/v1`
- **Content-Type**: `application/json`
- **响应格式**: JSON

### 4.2 响应状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 201 | 创建成功 |
| 400 | 请求参数错误 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

### 4.3 数据传输对象 (DTO)

#### 4.3.1 TodoCreateRequest
```java
public class TodoCreateRequest {
    @NotBlank(message = "标题不能为空")
    @Size(max = 255, message = "标题长度不能超过255个字符")
    private String title;
    
    @Size(max = 1000, message = "描述长度不能超过1000个字符")
    private String description;
}
```

#### 4.3.2 TodoUpdateRequest
```java
public class TodoUpdateRequest {
    @Size(min = 1, max = 255, message = "标题长度必须在1-255个字符之间")
    private String title;
    
    @Size(max = 1000, message = "描述长度不能超过1000个字符")
    private String description;
    
    private Boolean completed;
}
```

#### 4.3.3 TodoResponse
```java
public class TodoResponse {
    private Long id;
    private String title;
    private String description;
    private Boolean completed;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

#### 4.3.4 ApiResponse<T>
```java
public class ApiResponse<T> {
    private Integer code;
    private String message;
    private T data;
}
```

### 4.4 API接口列表

#### 4.4.1 获取所有待办事项
```
GET /api/v1/todos
```

**查询参数:**
- `completed`: 可选，筛选条件 (`true`/`false`/不传表示全部)

**响应示例:**
```json
{
    "code": 200,
    "message": "success",
    "data": [
        {
            "id": 1,
            "title": "学习Spring Boot",
            "description": "完成Spring Boot基础教程",
            "completed": false,
            "createdAt": "2024-01-01T10:00:00",
            "updatedAt": "2024-01-01T10:00:00"
        }
    ]
}
```

#### 4.4.2 获取单个待办事项
```
GET /api/v1/todos/{id}
```

**路径参数:**
- `id`: 待办事项ID

**响应示例:**
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "id": 1,
        "title": "学习Spring Boot",
        "description": "完成Spring Boot基础教程",
        "completed": false,
        "createdAt": "2024-01-01T10:00:00",
        "updatedAt": "2024-01-01T10:00:00"
    }
}
```

#### 4.4.3 创建待办事项
```
POST /api/v1/todos
```

**请求体:**
```json
{
    "title": "待办事项标题",
    "description": "详细描述（可选）"
}
```

**响应示例:**
```json
{
    "code": 201,
    "message": "Todo created successfully",
    "data": {
        "id": 2,
        "title": "待办事项标题",
        "description": "详细描述（可选）",
        "completed": false,
        "createdAt": "2024-01-01T10:30:00",
        "updatedAt": "2024-01-01T10:30:00"
    }
}
```

#### 4.4.4 更新待办事项
```
PUT /api/v1/todos/{id}
```

**路径参数:**
- `id`: 待办事项ID

**请求体:**
```json
{
    "title": "更新后的标题",
    "description": "更新后的描述",
    "completed": true
}
```

**响应示例:**
```json
{
    "code": 200,
    "message": "Todo updated successfully",
    "data": {
        "id": 1,
        "title": "更新后的标题",
        "description": "更新后的描述",
        "completed": true,
        "createdAt": "2024-01-01T10:00:00",
        "updatedAt": "2024-01-01T11:00:00"
    }
}
```

#### 4.4.5 切换待办事项状态
```
PATCH /api/v1/todos/{id}/toggle
```

**路径参数:**
- `id`: 待办事项ID

**响应示例:**
```json
{
    "code": 200,
    "message": "Todo status toggled successfully",
    "data": {
        "id": 1,
        "title": "待办事项标题",
        "description": "详细描述",
        "completed": true,
        "createdAt": "2024-01-01T10:00:00",
        "updatedAt": "2024-01-01T11:00:00"
    }
}
```

#### 4.4.6 删除待办事项
```
DELETE /api/v1/todos/{id}
```

**路径参数:**
- `id`: 待办事项ID

**响应示例:**
```json
{
    "code": 200,
    "message": "Todo deleted successfully"
}
```

#### 4.4.7 批量删除已完成的待办事项
```
DELETE /api/v1/todos/completed
```

**响应示例:**
```json
{
    "code": 200,
    "message": "Completed todos deleted successfully",
    "data": {
        "deletedCount": 3
    }
}
```

#### 4.4.8 删除所有待办事项
```
DELETE /api/v1/todos/all
```

**响应示例:**
```json
{
    "code": 200,
    "message": "All todos deleted successfully",
    "data": {
        "deletedCount": 10
    }
}
```

#### 4.4.9 健康检查
```
GET /health
```

**响应示例:**
```json
{
    "status": "UP",
    "timestamp": "2024-01-01T10:00:00Z",
    "version": "1.0.0"
}
```

### 4.5 错误响应格式

#### 4.5.1 参数验证错误
```json
{
    "code": 400,
    "message": "Validation failed",
    "errors": [
        {
            "field": "title",
            "message": "标题不能为空"
        }
    ]
}
```

#### 4.5.2 资源不存在错误
```json
{
    "code": 404,
    "message": "Todo not found with id: 999"
}
```

#### 4.5.3 服务器内部错误
```json
{
    "code": 500,
    "message": "Internal server error"
}
```

## 5. 安全配置

### 5.1 CORS配置
- 允许的源地址：`http://localhost:3000`
- 允许的方法：`GET, POST, PUT, DELETE, PATCH, OPTIONS`
- 允许的头部：`*`
- 支持凭证：`true`
- 预检请求缓存时间：`3600`秒

### 5.2 输入验证
- 所有输入参数必须经过验证
- 使用Bean Validation注解进行参数校验
- 防止SQL注入攻击
- XSS防护

## 6. 性能要求

### 6.1 响应时间
- API响应时间应小于200ms
- 数据库查询优化，使用索引
- 连接池配置优化

### 6.2 并发支持
- 支持至少100个并发用户
- 使用JPA乐观锁防止并发更新冲突

## 7. 测试策略

### 7.1 单元测试
- **目标覆盖率**: 80%以上
- **测试框架**: JUnit 5 + Mockito
- **测试内容**:
  - Service层业务逻辑测试
  - Repository层数据访问测试
  - DTO验证测试

#### 7.1.1 Service层测试示例
```java
@ExtendWith(MockitoExtension.class)
class TodoServiceTest {
    
    @Mock
    private TodoRepository todoRepository;
    
    @InjectMocks
    private TodoService todoService;
    
    @Test
    void shouldCreateTodoSuccessfully() {
        // 测试创建待办事项逻辑
    }
    
    @Test
    void shouldThrowExceptionWhenTodoNotFound() {
        // 测试异常处理逻辑
    }
}
```

### 7.2 集成测试
- **测试框架**: Spring Boot Test + TestContainers
- **测试内容**:
  - Controller层API接口测试
  - 数据库集成测试
  - 完整的请求-响应流程测试

#### 7.2.1 Controller集成测试示例
```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@TestMethodOrder(OrderAnnotation.class)
class TodoControllerIntegrationTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    @Order(1)
    void shouldCreateTodo() {
        // 测试创建API
    }
    
    @Test
    @Order(2)
    void shouldGetAllTodos() {
        // 测试查询API
    }
    
    @Test
    @Order(3)
    void shouldUpdateTodo() {
        // 测试更新API
    }
    
    @Test
    @Order(4)
    void shouldDeleteTodo() {
        // 测试删除API
    }
}
```

### 7.3 端到端测试
- **工具**: Postman + Newman
- **测试内容**:
  - 完整业务流程测试
  - 多用户场景测试
  - 错误处理测试

#### 7.3.1 测试用例列表
1. **基础CRUD测试**
   - 创建待办事项
   - 查询待办事项列表
   - 更新待办事项
   - 删除待办事项

2. **业务逻辑测试**
   - 状态切换功能
   - 筛选功能测试
   - 批量删除测试

3. **边界条件测试**
   - 空标题创建测试
   - 超长内容测试
   - 不存在ID操作测试

4. **并发测试**
   - 多用户同时操作同一待办事项
   - 高并发创建测试

### 7.4 性能测试
- **工具**: JMeter
- **测试指标**:
  - 响应时间 < 200ms
  - 吞吐量 > 1000 req/s
  - 并发用户数 >= 100

### 7.5 测试数据管理
```java
@TestConfiguration
public class TestDataConfig {
    
    @Bean
    @Primary
    public TodoRepository testTodoRepository() {
        // 返回测试用的Repository实现
        return new InMemoryTodoRepository();
    }
}
```

### 7.6 自动化测试
- **CI/CD集成**: GitHub Actions / Jenkins
- **测试执行策略**:
  - 每次提交触发单元测试
  - PR合并前执行集成测试
  - 发布前执行完整测试套件

### 7.7 测试报告
- **覆盖率报告**: JaCoCo
- **测试结果报告**: Surefire Report
- **性能测试报告**: JMeter HTML Report

## 8. 监控和日志

### 8.1 应用监控
- **健康检查**: Spring Boot Actuator
- **指标监控**: Micrometer + Prometheus
- **应用性能监控**: 响应时间、错误率、吞吐量

### 8.2 日志管理
- **日志框架**: Logback
- **日志级别**: DEBUG、INFO、WARN、ERROR
- **日志格式**: JSON格式便于分析
- **日志内容**: 请求ID、用户操作、错误堆栈

### 8.3 告警机制
- **错误率告警**: 错误率超过5%
- **响应时间告警**: 平均响应时间超过500ms
- **资源使用告警**: CPU、内存使用率超过80%
